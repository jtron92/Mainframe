import imaplib
import email
import os
import subprocess
from ftplib import FTP

# Gmail IMAP credentials
EMAIL = "jxcsys92@gmail.com"
APP_PASSWORD = "************"

# Mainframe FTP details
FTP_HOST = "192.168.4.150"
FTP_USER = "IBMUSER"
FTP_PASS = "YOUR_MF_PASSWORD"  # Replace this
TARGET_DATASET = "IBMUSER.FROM.EMAIL.MSG"

# Output files on Linux
UTF8_FILE = "/home/jtron/from_gmail.txt"
EBCDIC_FILE = "/home/jtron/from_gmail_ebcdic.txt"

# Connect to Gmail
imap = imaplib.IMAP4_SSL("imap.gmail.com")
imap.login(EMAIL, APP_PASSWORD)
imap.select("inbox")

# Look for unread messages with subject: SEND TO MF
status, messages = imap.search(None, '(UNSEEN SUBJECT "SEND TO MF")')

if status == "OK" and messages[0]:
    for num in messages[0].split():
        status, data = imap.fetch(num, "(RFC822)")
        if status != "OK":
            continue

        msg = email.message_from_bytes(data[0][1])
        body = ""

        if msg.is_multipart():
            for part in msg.walk():
                if part.get_content_type() == "text/plain":
                    body += part.get_payload(decode=True).decode()
        else:
            body = msg.get_payload(decode=True).decode()

        # Save UTF-8 version (padded FB 80)
        with open(UTF8_FILE, "w") as f:
            for line in body.strip().splitlines():
                f.write(line[:80].ljust(80) + "\n")

        # Convert to EBCDIC (code page 1047) using iconv
        subprocess.run([
            "iconv", "-f", "UTF-8", "-t", "IBM1047",
            UTF8_FILE, "-o", EBCDIC_FILE
        ])

        # FTP to z/OS in EBCDIC
        with FTP(FTP_HOST) as ftp:
            ftp.login(FTP_USER, FTP_PASS)
            with open(EBCDIC_FILE, "rb") as f:
                ftp.storbinary(f"STOR '" + TARGET_DATASET + "'", f)

        print(f"âœ… Message converted to EBCDIC and saved to {TARGET_DATASET}")
        break
else:
    print("ðŸ“­ No matching unread messages found.")

imap.logout()
